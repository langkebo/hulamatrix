name: UI/UX Quality Checks

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]
  schedule:
    # 每天凌晨 2 点运行
    - cron: '0 2 * * *'

jobs:
  uiux-audit:
    name: UI/UX Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run UI/UX check
        run: node scripts/ui-ux-check.cjs

      - name: Upload UI/UX report
        uses: actions/upload-artifact@v4
        with:
          name: ui-ux-report
          path: ui-ux-report.json
          retention-days: 30

  design-tokens:
    name: Design Tokens Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check design tokens
        run: node scripts/check-design-tokens.cjs

  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    needs: [uiux-audit, design-tokens]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          uploadArtifacts: true
          temporaryPublicStorage: true
          urls: |
            http://localhost:6130
          budgetPath: ./.github/lighthouse-budget.json
          configPath: ./.github/lighthouse-config.js

  accessibility:
    name: Accessibility Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build

      - name: Install Pa11y
        run: npm install -g pa11y

      - name: Run accessibility tests
        run: |
          # 启动开发服务器（后台）
          pnpm dev &
          DEV_PID=$!

          # 等待服务器启动
          sleep 30

          # 运行 Pa11y 测试
          pa11y http://localhost:6130 --reporter json > pa11y-report.json || true

          # 停止服务器
          kill $DEV_PID

      - name: Upload Pa11y report
        uses: actions/upload-artifact@v4
        with:
          name: pa11y-report
          path: pa11y-report.json
          retention-days: 30

      - name: Check Pa11y results
        run: |
          # 检查是否有严重错误
          ERROR_COUNT=$(cat pa11y-report.json | grep -o '"error":true' | wc -l)
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "发现 $ERROR_COUNT 个可访问性问题"
            exit 1
          fi

  image-optimization:
    name: Image Optimization Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install image optimization tools
        run: |
          sudo apt-get update
          sudo apt-get install -y webp

      - name: Check image sizes
        run: |
          echo "检查 public 目录中的图片大小..."

          # 检查表情包
          echo "表情包:"
          ls -lh public/emoji/*.webp | awk '{print $5, $9}'

          # 检查头像
          echo "头像:"
          ls -lh public/avatar/*.webp | awk '{print $5, $9}'

          # 计算总大小
          EMOJI_SIZE=$(du -sh public/emoji | cut -f1)
          AVATAR_SIZE=$(du -sh public/avatar | cut -f1)

          echo ""
          echo "表情包总大小: $EMOJI_SIZE"
          echo "头像总大小: $AVATAR_SIZE"

      - name: Run image optimization (dry-run)
        run: node scripts/optimize-images.cjs --dry-run

  report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [uiux-audit, design-tokens, lighthouse, accessibility]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate summary
        run: |
          echo "# UI/UX Quality Report" > summary.md
          echo "" >> summary.md
          echo "## Checks Completed" >> summary.md
          echo "- UI/UX Audit: ${{ needs.uiux-audit.result }}" >> summary.md
          echo "- Design Tokens: ${{ needs.design-tokens.result }}" >> summary.md
          echo "- Lighthouse: ${{ needs.lighthouse.result }}" >> summary.md
          echo "- Accessibility: ${{ needs.accessibility.result }}" >> summary.md

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
