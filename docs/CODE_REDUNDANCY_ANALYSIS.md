# ä»£ç å†—ä½™åˆ†æä¸æ¸…ç†å»ºè®®

**æ—¥æœŸ**: 2026-01-03
**åˆ†æ”¯**: feature/matrix-sdk-optimization
**çŠ¶æ€**: åˆ†æå®Œæˆ

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

ç»è¿‡å…¨é¢åˆ†æï¼Œé¡¹ç›®å½“å‰å­˜åœ¨ä»¥ä¸‹ä¸»è¦å†—ä½™é—®é¢˜ï¼š
- 20 ä¸ª TODO/FIXME æ ‡è®°
- 536 å¤„ Store å¯¼å…¥
- å¤šä¸ªè¶…å¤§å‹æ–‡ä»¶ï¼ˆ>1500è¡Œï¼‰
- Store é—´å­˜åœ¨ä¾èµ–è€¦åˆ

---

## 1. Store å¾ªç¯ä¾èµ–åˆ†æ

### å½“å‰ä¾èµ–å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  global.ts      â”‚â”€â”€â”€â”€â”€â”€â”
â”‚ (å¯¼å…¥ chat.ts)  â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
        â”‚               â”‚
        â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   chat.ts       â”‚  â”‚ privateChat  â”‚
â”‚ (å¯¼å…¥ room,     â”‚  â”‚ .ts          â”‚
â”‚  user, etc)     â”‚  â”‚ (å¯¼å…¥ global,â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  chat)       â”‚
        â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  room.ts        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‘ç°çš„é—®é¢˜

| Store | å¯¼å…¥çš„å…¶ä»– Store | çŠ¶æ€ |
|-------|----------------|------|
| `announcement.ts` | `dataCache`, `global`, `group`, `user` | âš ï¸ å¤šä¾èµ– |
| `group.ts` | `global`, `user` | âœ… å¯æ¥å— |
| `chat.ts` | `room`, `user`, `sessionUnread` | âœ… å¯æ¥å— |
| `privateChat.ts` | `global`, `chat`, `group` | âš ï¸ å¤šä¾èµ– |
| `global.ts` | `chat` | âš ï¸ åå‘ä¾èµ– |
| `friends.ts` | `matrixAuth` | âœ… å¯æ¥å— |

### è¯„ä¼°ç»“è®º

**âœ… æ— ä¸¥é‡å¾ªç¯ä¾èµ–**

è™½ç„¶å­˜åœ¨ä¸€äº›ç›¸äº’ä¾èµ–ï¼Œä½†æ²¡æœ‰å½¢æˆçœŸæ­£çš„å¾ªç¯å¼•ç”¨ï¼š
- `chat.ts` æ²¡æœ‰å¯¼å…¥ `global.ts`
- `privateChat.ts` å¯¼å…¥ `global.ts` å’Œ `chat.ts`ï¼Œä½†å®ƒä»¬ä¹‹é—´æ²¡æœ‰å¾ªç¯

**å»ºè®®**ï¼š
- ä¿æŒç°çŠ¶ï¼Œæ— éœ€é‡æ„
- å¯ä»¥è€ƒè™‘å°† `global.ts` é‡å‘½åä¸ºæ›´å…·ä½“çš„åç§°

---

## 2. TODO/FIXME åˆ†æ

### åˆ†ç±»ç»Ÿè®¡

| ä¼˜å…ˆçº§ | æ•°é‡ | è¯´æ˜ |
|--------|------|------|
| é«˜ | 5 | å½±å“æ ¸å¿ƒåŠŸèƒ½ |
| ä¸­ | 10 | å¯é€‰åŠŸèƒ½å¢å¼º |
| ä½ | 5 | æ³¨é‡Šæ€§æ ‡è®° |

### é«˜ä¼˜å…ˆçº§ TODO (éœ€è¦å¤„ç†)

#### 1. stores/core/index.ts (2ä¸ª)

```typescript
// Line 1466
// TODO: éœ€è¦åœ¨ matrixCallService ä¸­å®ç° setMuted æ–¹æ³•

// Line 1484
// TODO: éœ€è¦åœ¨ matrixCallService ä¸­å®ç° setVideoEnabled æ–¹æ³•
```

**é—®é¢˜**: æ ¸å¿ƒé€šè¯åŠŸèƒ½æœªå®ç°
**å½±å“**: é€šè¯é™éŸ³å’Œè§†é¢‘å¼€å…³åŠŸèƒ½
**å»ºè®®**: åœ¨ `matrixCallService.ts` ä¸­å®ç°è¿™ä¸¤ä¸ªæ–¹æ³•

#### 2. App.vue (3ä¸ª)

```typescript
// Lines 168, 173, 286
// TODO: getNoticeUnreadCount - custom notification system, needs Matrix-based implementation
```

**é—®é¢˜**: é€šçŸ¥ç³»ç»Ÿæœªå®Œæˆ
**å½±å“**: é€šçŸ¥æœªè¯»è®¡æ•°åŠŸèƒ½
**å»ºè®®**: å®ç° Matrix é€šçŸ¥è®¡æ•°API

#### 3. global.ts (1ä¸ª)

```typescript
// Line 62
// æ·»åŠ å¥½å‹æ¨¡æ€æ¡†ä¿¡æ¯ TODO: è™šæ‹Ÿåˆ—è¡¨æ·»åŠ å¥½å‹æœ‰æ—¶å€™ä¼šä¸å±•ç¤ºå¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯
```

**é—®é¢˜**: è™šæ‹Ÿåˆ—è¡¨UIé—®é¢˜
**å½±å“**: å¥½å‹æ·»åŠ åŠŸèƒ½ä½“éªŒ
**å»ºè®®**: ä¿®å¤è™šæ‹Ÿåˆ—è¡¨çš„æ•°æ®åŠ è½½é€»è¾‘

### ä¸­ä¼˜å…ˆçº§ TODO (å¯é€‰)

| æ–‡ä»¶ | TODOå†…å®¹ | å»ºè®® |
|------|---------|------|
| `ChatMsgMultiChoose.vue:351` | Matrixæ¶ˆæ¯è½¬å‘ | ä½¿ç”¨m.referenceå®ç° |
| `SpaceSettings.vue:445,451,476` | é€šçŸ¥è®¾ç½®ã€å…³é”®è¯ã€å¯è§æ€§ | æŒ‰éœ€å®ç° |
| `MobileSpaceList.vue` | åˆ†é¡µã€åˆ†äº«ã€è®¾ç½® | é€æ­¥å®ç° |
| Adminè§†å›¾ | å¯¼èˆªåŠŸèƒ½ | æ·»åŠ è·¯ç”±è·³è½¬ |

### ä½ä¼˜å…ˆçº§ TODO (æ³¨é‡Š)

```typescript
// matrixSpacesService.ts:979
// TODO: Track presence
```

**è¯´æ˜**: ä»…ä»£ç æ³¨é‡Šï¼ŒåŠŸèƒ½åŸºæœ¬å®ç°

---

## 3. å¤§å‹æ–‡ä»¶åˆ†æ

### TypeScript æ–‡ä»¶ (>1500è¡Œ)

| æ–‡ä»¶ | è¡Œæ•° | ç±»å‹ | ä¼˜å…ˆçº§ | å»ºè®® |
|------|------|------|--------|------|
| `matrixCallService.ts` | 1807 | æœåŠ¡ | **é«˜** | æ‹†åˆ†ä¸ºå¤šä¸ªæ¨¡å— |
| `stores/core/index.ts` | 1751 | Store | **é«˜** | æ‹†åˆ†ä¸“é—¨åŒ–æ¨¡å— |
| `enhancedFriendsService.ts` | 1641 | æœåŠ¡ | ä¸­ | ä¿ç•™ï¼ˆSynapse APIï¼‰ |
| `chat.ts` | 1623 | Store | ä¸­ | è€ƒè™‘æ‹†åˆ† |
| `useChatMain.ts` | 1449 | Hook | ä¸­ | åŠŸèƒ½å¤æ‚ï¼Œç»„ç»‡è‰¯å¥½ |
| `error-handler.ts` | 1366 | å·¥å…· | ä½ | é€»è¾‘å®Œæ•´ |

### Vue ç»„ä»¶ (>1500è¡Œ)

| ç»„ä»¶ | è¡Œæ•° | ç±»å‹ | ä¼˜å…ˆçº§ | å»ºè®® |
|------|------|------|--------|------|
| `Screenshot.vue` | 1710 | ç»„ä»¶ | ä½ | åŠŸèƒ½å¤æ‚ä½†ç»„ç»‡è‰¯å¥½ |
| `SpaceDetails.vue` | 1655 | ç»„ä»¶ | ä¸­ | æ‹†åˆ†å­ç»„ä»¶ |
| `ManageSpaceDialog.vue` | 1647 | ç»„ä»¶ | ä¸­ | æ‹†åˆ†å­ç»„ä»¶ |
| `MatrixChatSidebar.vue` | 1641 | ç»„ä»¶ | ä¸­ | æ‹†åˆ†å­ç»„ä»¶ |

---

## 4. é‡å¤ä»£ç æ¨¡å¼

### 4.1 æƒé™æ£€æŸ¥æ¨¡å¼

**ä½ç½®**: å¤šä¸ªç»„ä»¶ä¸­é‡å¤å®ç°

| æ–‡ä»¶ | æ¨¡å¼ |
|------|------|
| `SpaceSettings.vue` | Power Level æ£€æŸ¥ |
| `RoomSettings.vue` | Power Level æ£€æŸ¥ |
| `MatrixInviteMember.vue` | æƒé™éªŒè¯ |

**å»ºè®®**: åˆ›å»ºç»Ÿä¸€çš„æƒé™æ£€æŸ¥ composable

```typescript
// composables/useMatrixPermissions.ts
export function useMatrixPermissions() {
  function canModifySpace(room: MatrixRoom) { ... }
  function canInviteUsers(room: MatrixRoom) { ... }
  function canModifyPowerLevels(room: MatrixRoom) { ... }
}
```

### 4.2 ç§»åŠ¨/æ¡Œé¢ç›¸ä¼¼ç»„ä»¶

| åŠŸèƒ½ | æ¡Œé¢ | ç§»åŠ¨ |
|------|------|------|
| èŠå¤©è¾“å…¥ | `MatrixMsgInput.vue` | `FooterBar.vue` |
| æ¶ˆæ¯åˆ—è¡¨ | `MatrixChatMain.vue` | `chat-room/index.vue` |
| ç©ºé—´åˆ—è¡¨ | `SpaceCard.vue` | `MobileSpaceList.vue` |
| è®¾å¤‡éªŒè¯ | `DeviceVerification.vue` | `MobileDeviceVerificationDialog.vue` |

**å»ºè®®**: æå–å…±äº«é€»è¾‘åˆ° composables

### 4.3 æ¶ˆæ¯æ¸²æŸ“ç»„ä»¶

**ä½ç½®**: `src/components/rightBox/renderMessage/`

åŒ…å«å¤šä¸ªç›¸ä¼¼çš„æ¸²æŸ“ç»„ä»¶ï¼š
- `Text.vue`
- `Image.vue`
- `Video.vue`
- `File.vue`
- `Audio.vue`

**å»ºè®®**: åˆ›å»ºç»Ÿä¸€çš„æ¸²æŸ“åŸºç±»

---

## 5. ä¼˜åŒ–å»ºè®®ä¼˜å…ˆçº§

### P0 - ç«‹å³å¤„ç†

1. âœ… **å·²å®Œæˆ**: ä¿®å¤ Rust è­¦å‘Š
2. âœ… **å·²å®Œæˆ**: ä¿®å¤ TypeScript ç±»å‹é”™è¯¯
3. â³ **è¿›è¡Œä¸­**: æ¸…ç†æœªä½¿ç”¨ä»£ç 

### P1 - é«˜ä¼˜å…ˆçº§ï¼ˆæœ¬å‘¨ï¼‰

1. **å®ç°æ ¸å¿ƒ TODO**:
   - [ ] `matrixCallService.ts` æ·»åŠ  `setMuted` å’Œ `setVideoEnabled` æ–¹æ³•
   - [ ] ä¿®å¤è™šæ‹Ÿåˆ—è¡¨å¥½å‹æ˜¾ç¤ºé—®é¢˜
   - [ ] å®ç°é€šçŸ¥æœªè¯»è®¡æ•°

2. **æ‹†åˆ†è¶…å¤§å‹æ–‡ä»¶**:
   - [ ] æ‹†åˆ† `matrixCallService.ts` (1807è¡Œ)
   - [ ] æ‹†åˆ† `stores/core/index.ts` (1751è¡Œ)

### P2 - ä¸­ä¼˜å…ˆçº§ï¼ˆ1-2å‘¨ï¼‰

1. **æƒé™æ£€æŸ¥ç»Ÿä¸€åŒ–**:
   - [ ] åˆ›å»º `useMatrixPermissions` composable
   - [ ] æ›¿æ¢ç°æœ‰æƒé™æ£€æŸ¥ä»£ç 

2. **ç»„ä»¶æ‹†åˆ†**:
   - [ ] æ‹†åˆ† `SpaceDetails.vue`
   - [ ] æ‹†åˆ† `ManageSpaceDialog.vue`
   - [ ] æ‹†åˆ† `MatrixChatSidebar.vue`

### P3 - ä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸï¼‰

1. **ç§»åŠ¨/æ¡Œé¢ç»„ä»¶å…±äº«**:
   - [ ] æå–å…±äº« composables
   - [ ] ç»Ÿä¸€æ¶ˆæ¯æ¸²æŸ“é€»è¾‘

---

## 6. å»ºè®®çš„æ–‡ä»¶é‡ç»„

### stores/core/index.ts æ‹†åˆ†æ–¹æ¡ˆ

å½“å‰ç»“æ„ (1751è¡Œ):
```
stores/core/index.ts
â”œâ”€â”€ ç±»å‹å®šä¹‰ (300è¡Œ)
â”œâ”€â”€ UI çŠ¶æ€ç®¡ç† (200è¡Œ)
â”œâ”€â”€ ç”¨æˆ·è®¤è¯ (150è¡Œ)
â”œâ”€â”€ èŠå¤©æ¶ˆæ¯ (400è¡Œ)
â”œâ”€â”€ åª’ä½“æ–‡ä»¶ (300è¡Œ)
â”œâ”€â”€ é€šè¯åŠŸèƒ½ (200è¡Œ)
â””â”€â”€ å¯¼å‡º (100è¡Œ)
```

å»ºè®®ç»“æ„:
```
stores/core/
â”œâ”€â”€ index.ts (ä¸»å…¥å£ï¼Œ50è¡Œ)
â”œâ”€â”€ types.ts (ç±»å‹å®šä¹‰ï¼Œ300è¡Œ)
â”œâ”€â”€ ui.ts (UIçŠ¶æ€ï¼Œ200è¡Œ)
â”œâ”€â”€ auth.ts (è®¤è¯ï¼Œ150è¡Œ)
â”œâ”€â”€ chat.ts (èŠå¤©ï¼Œ400è¡Œ)
â”œâ”€â”€ media.ts (åª’ä½“ï¼Œ300è¡Œ)
â””â”€â”€ call.ts (é€šè¯ï¼Œ200è¡Œ)
```

### matrixCallService.ts æ‹†åˆ†æ–¹æ¡ˆ

å½“å‰ç»“æ„ (1807è¡Œ):
```
matrixCallService.ts
â”œâ”€â”€ ç±»å‹å®šä¹‰ (200è¡Œ)
â”œâ”€â”€ Matrix SDK é›†æˆ (400è¡Œ)
â”œâ”€â”€ é€šè¯çŠ¶æ€ç®¡ç† (300è¡Œ)
â”œâ”€â”€ åª’ä½“è®¾å¤‡ç®¡ç† (300è¡Œ)
â”œâ”€â”€ WebRTC å¤„ç† (400è¡Œ)
â””â”€â”€ è¾…åŠ©åŠŸèƒ½ (207è¡Œ)
```

å»ºè®®ç»“æ„:
```
services/call/
â”œâ”€â”€ index.ts (ä¸»å…¥å£)
â”œâ”€â”€ types.ts (ç±»å‹å®šä¹‰)
â”œâ”€â”€ matrix-integration.ts (SDKé›†æˆ)
â”œâ”€â”€ state-manager.ts (çŠ¶æ€ç®¡ç†)
â”œâ”€â”€ media-devices.ts (è®¾å¤‡ç®¡ç†)
â”œâ”€â”€ webrtc-handler.ts (WebRTC)
â””â”€â”€ utils.ts (è¾…åŠ©åŠŸèƒ½)
```

---

## 7. æ€»ç»“

### å½“å‰çŠ¶æ€è¯„ä¼°

| ç±»åˆ« | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| ä»£ç ç»„ç»‡ | 7/10 | å¤§æ–‡ä»¶è¾ƒå¤šï¼Œéœ€è¦æ‹†åˆ† |
| å†—ä½™ä»£ç  | 8/10 | é‡å¤è¾ƒå°‘ï¼Œä¸»è¦æ˜¯åŠŸèƒ½ç›¸ä¼¼ |
| Store æ¶æ„ | 8/10 | æ— ä¸¥é‡å¾ªç¯ä¾èµ– |
| TODO ç®¡ç† | 6/10 | 20ä¸ªTODOéœ€è¦æ¸…ç† |

### ä¼˜å…ˆè¡ŒåŠ¨

**æœ¬å‘¨**:
1. å®ç°5ä¸ªé«˜ä¼˜å…ˆçº§TODO
2. æ‹†åˆ† `stores/core/index.ts`

**ä¸‹å‘¨**:
1. æ‹†åˆ† `matrixCallService.ts`
2. åˆ›å»ºæƒé™æ£€æŸ¥ composable

**é•¿æœŸ**:
1. ç»„ä»¶æ‹†åˆ†å’Œä¼˜åŒ–
2. ç§»åŠ¨/æ¡Œé¢ä»£ç å…±äº«

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-03
**ä¸‹æ¬¡å®¡æŸ¥**: 1å‘¨å
